<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signbook</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="signbook.css" />
    <style>
        /* Temporary CSS for signbook until signbook.css is ready */
        body, .navbar, .main-container {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Libre Franklin', sans-serif;
        }
        body {
            background-color: #f0f0f0;
            color: #000;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadPosts();
        });

        function addNewPost() {
            const newPostText = document.getElementById('new-post-text').value;
            const postAuthor = document.getElementById('post-author').value.trim() || 'anonymous';
            const newPostImage = document.getElementById('new-post-image').files[0];

            if (newPostText.trim() === '' && !newPostImage) return;

            let imageUrl = '';
            if (newPostImage) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageUrl = e.target.result;
                    const post = {
                        author: postAuthor,
                        content: newPostText,
                        date: new Date().toISOString(),
                        imageUrl: imageUrl,
                        replies: []
                    };
                    savePost(post);
                    renderPost(post);
                };
                reader.readAsDataURL(newPostImage);
            } else {
                const post = {
                    author: postAuthor,
                    content: newPostText,
                    date: new Date().toISOString(),
                    imageUrl: imageUrl,
                    replies: []
                };
                savePost(post);
                renderPost(post);
            }

            document.getElementById('new-post-text').value = '';
            document.getElementById('post-author').value = '';
            document.getElementById('new-post-image').value = '';
        }

        function savePost(post) {
            fetch('http://localhost:3000/api/posts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(post)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Post saved successfully:', data);
            })
            .catch(error => {
                console.error('Error saving post:', error);
            });
        }

        function loadPosts() {
            fetch('http://localhost:3000/api/posts')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(posts => {
                    posts.forEach(post => renderPost(post));
                })
                .catch(error => {
                    console.error('Error loading posts:', error);
                });
        }

        function renderPost(post) {
            const postElement = document.createElement('div');
            postElement.className = 'post';

            const postHeader = document.createElement('div');
            postHeader.className = 'post-header';
            postHeader.textContent = `${post.author} - ${new Date(post.date).toLocaleString('en-US', { timeZone: 'America/New_York' })}`;

            const postContent = document.createElement('div');
            postContent.className = 'post-content';
            postContent.textContent = post.content;

            postElement.appendChild(postHeader);
            postElement.appendChild(postContent);

            if (post.imageUrl) {
                const postImage = document.createElement('img');
                postImage.className = 'post-image';
                postImage.src = post.imageUrl;
                postElement.appendChild(postImage);
            }

            const postControls = document.createElement('div');
            postControls.className = 'post-controls';

            const replyButton = document.createElement('button');
            replyButton.textContent = 'Reply';
            replyButton.onclick = () => toggleReplyForm(postElement);

            postControls.appendChild(replyButton);
            postElement.appendChild(postControls);

            const repliesContainer = document.createElement('div');
            repliesContainer.className = 'replies-container';
            post.replies.forEach(reply => {
                const replyElement = document.createElement('div');
                replyElement.className = 'reply';
                replyElement.innerHTML = `<strong>${reply.author}:</strong> ${reply.content}`;
                repliesContainer.appendChild(replyElement);
            });
            postElement.appendChild(repliesContainer);

            document.querySelector('.posts-container').prepend(postElement);
        }

        function toggleReplyForm(postElement) {
            let replyForm = postElement.querySelector('.reply-form');
            if (replyForm) {
                replyForm.remove();
            } else {
                replyForm = document.createElement('div');
                replyForm.className = 'reply-form';
                replyForm.innerHTML = `
                    <input type="text" class="reply-author" placeholder="Your name">
                    <textarea class="reply-text" placeholder="Write your reply..."></textarea>
                    <button onclick="addReply(this)">Reply</button>
                `;
                postElement.appendChild(replyForm);
            }
        }

        function addReply(button) {
            const replyForm = button.parentElement;
            const postElement = replyForm.closest('.post');
            const postDate = postElement.querySelector('.post-header').textContent.split(' - ')[1];
            const replyAuthor = replyForm.querySelector('.reply-author').value.trim() || 'anonymous';
            const replyText = replyForm.querySelector('.reply-text').value.trim();

            if (replyText === '') return;

            fetch('http://localhost:3000/api/posts/reply', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ date: postDate, reply: { author: replyAuthor, content: replyText } })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Reply added successfully:', data);
                const replyElement = document.createElement('div');
                replyElement.className = 'reply';
                replyElement.innerHTML = `<strong>${replyAuthor}:</strong> ${replyText}`;
                postElement.querySelector('.replies-container').appendChild(replyElement);
                replyForm.querySelector('.reply-author').value = '';
                replyForm.querySelector('.reply-text').value = '';
            })
            .catch(error => {
                console.error('Error adding reply:', error);
            });
        }
    </script>
</head>
<body>
    <div class="navbar">
        <a href="mainpage.html" class="brand" style="text-decoration: none;">Signbook</a>
        <ul>
            <li><a href="clock.html">Clock</a></li>
            <li><a href="calendar.html">Calendar</a></li>
            <li><a href="upload.html">Image Desktop</a></li>
            <li><a href="signbook.html">Signbook</a></li>
            <li><a href="gallery.html">Gallery</a></li>
            <li><a href="settings.html">Settings</a></li>
        </ul>
    </div>
    <div class="main-container">
        <div class="new-post">
            <input type="text" id="post-author" placeholder="Name">
            <textarea id="new-post-text" placeholder="What's on your mind?"></textarea>
            <input type="file" id="new-post-image" accept="image/*">
            <button onclick="addNewPost()">Post</button>
        </div>
        <div class="posts-container"></div>
    </div>
</body>
</html>