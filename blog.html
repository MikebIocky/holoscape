<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="blog.css" />
    <style>
        .warning-container {
            background-color: #ffffcc;
            color: #000;
            padding: 20px;
            border: 2px solid #ffcc00;
            box-shadow: 4px 4px 0px #000;
            margin-bottom: 20px;
        }
        .warning-container h2 {
            font-size: 1.8em;
            font-weight: bold;
            color: #cc6600;
            margin-bottom: 10px;
        }
        .warning-container p {
            font-size: 1em;
            line-height: 1.6;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Apply saved theme color from localStorage
            const savedTheme = localStorage.getItem('themeColor');
            if (savedTheme) {
                document.body.style.backgroundColor = savedTheme;
            }
            loadPosts();
        });

        function changeThemeColor() {
            const themeColor = document.getElementById('theme-color').value;
            document.body.style.backgroundColor = themeColor;
            localStorage.setItem('themeColor', themeColor);
        }

        function addNewPost() {
            const newPostText = document.getElementById('new-post-text').value;
            const blogAuthor = document.getElementById('blog-author').value.trim() || 'anonymous';
            const newPostImage = document.getElementById('new-post-image').files[0];

            if (newPostText.trim() === '' && !newPostImage) return;

            let imageUrl = '';
            if (newPostImage) {
                // Read image file and convert to URL
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageUrl = e.target.result;
                    const post = {
                        author: blogAuthor,
                        content: newPostText,
                        date: new Date().toISOString(),
                        imageUrl: imageUrl,
                        replies: []
                    };
                    savePost(post);
                    renderPost(post);
                };
                reader.readAsDataURL(newPostImage);
            } else {
                const post = {
                    author: blogAuthor,
                    content: newPostText,
                    date: new Date().toISOString(),
                    imageUrl: imageUrl,
                    replies: []
                };
                savePost(post);
                renderPost(post);
            }

            document.getElementById('new-post-text').value = '';
            document.getElementById('blog-author').value = '';
            document.getElementById('new-post-image').value = '';
        }

        function savePost(post) {
            // Save post as a markdown file to the server
            fetch('http://localhost:3000/api/posts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(post),
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Post saved:', data);
                })
                .catch(error => {
                    console.error('Error saving post:', error);
                });
        }

        function loadPosts() {
            // Load posts from the server
            fetch('http://localhost:3000/api/posts')
                .then(response => response.json())
                .then(posts => {
                    posts.forEach(post => renderPost(post));
                })
                .catch(error => {
                    console.error('Error loading posts:', error);
                });
        }

        function renderPost(post) {
            const postElement = document.createElement('div');
            postElement.className = 'post';

            const postHeader = document.createElement('div');
            postHeader.className = 'post-header';
            postHeader.textContent = `${post.author} - ${new Date(post.date).toLocaleString('en-US', { timeZone: 'America/New_York' })}`;

            const postContent = document.createElement('div');
            postContent.className = 'post-content';
            postContent.textContent = post.content;

            postElement.appendChild(postHeader);
            postElement.appendChild(postContent);

            if (post.imageUrl) {
                const postImage = document.createElement('img');
                postImage.className = 'post-image';
                postImage.src = post.imageUrl;
                postElement.appendChild(postImage);
            }

            const postControls = document.createElement('div');
            postControls.className = 'post-controls';

            const replyButton = document.createElement('button');
            replyButton.textContent = 'Reply';
            replyButton.onclick = () => toggleReplyForm(postElement);

            postControls.appendChild(replyButton);

            postElement.appendChild(postControls);

            const repliesContainer = document.createElement('div');
            repliesContainer.className = 'replies-container';
            post.replies.forEach(reply => {
                const replyElement = document.createElement('div');
                replyElement.className = 'reply';
                replyElement.innerHTML = `<strong>${reply.author}:</strong> ${reply.content}`;
                repliesContainer.appendChild(replyElement);
            });
            postElement.appendChild(repliesContainer);

            document.querySelector('.posts-container').prepend(postElement);
        }

        function toggleReplyForm(postElement) {
            let replyForm = postElement.querySelector('.reply-form');
            if (replyForm) {
                replyForm.remove();
            } else {
                replyForm = document.createElement('div');
                replyForm.className = 'reply-form';
                replyForm.innerHTML = `
                    <input type="text" class="reply-author" placeholder="Your name">
                    <textarea class="reply-text" placeholder="Write your reply..."></textarea>
                    <button onclick="addReply(this)">Reply</button>
                `;
                postElement.appendChild(replyForm);
            }
        }

        function addReply(button) {
            const replyForm = button.parentElement;
            const postElement = replyForm.closest('.post');
            const postDate = postElement.querySelector('.post-header').textContent.split(' - ')[1];
            const replyAuthor = replyForm.querySelector('.reply-author').value.trim() || 'anonymous';
            const replyText = replyForm.querySelector('.reply-text').value.trim();

            if (replyText === '') return;

            const reply = {
                author: replyAuthor,
                content: replyText
            };

            // Save reply to the server
            fetch(`http://localhost:3000/api/posts/reply`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ postDate, reply }),
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Reply saved:', data);
                    const replyElement = document.createElement('div');
                    replyElement.className = 'reply';
                    replyElement.innerHTML = `<strong>${reply.author}:</strong> ${reply.content}`;
                    postElement.querySelector('.replies-container').appendChild(replyElement);
                })
                .catch(error => {
                    console.error('Error saving reply:', error);
                });

            replyForm.querySelector('.reply-author').value = '';
            replyForm.querySelector('.reply-text').value = '';
        }
    </script>
</head>
<body>
    <div class="navbar">
        <a href="mainpage.html" class="brand" style="text-decoration: none;">:D</a>
        <ul>
            <li><a href="clock.html">Clock</a></li>
            <li><a href="calendar.html">Calendar</a></li>
            <li><a href="upload.html">Image desktop</a></li>
            <li><a href="blog.html">Blogs</a></li>
            <li><a href="gallery.html">Gallery</a></li>
            <li><a href="settings.html">Settings</a></li>
        </ul>
    </div>
    <div class="main-container">
        <div class="warning-container">
            <h2>Warning</h2>
            <p>This feature isn't working correctly right now. Currently, there aren't any suitable replacements for this feature, so it has been temporarily deprecated. You are still able to use it, but all the uploaded images/GIFs/videos are only saved if you use the same browser. Other people won't be able to see them. Despite all of that, I have found the decent alternative place to upload your post out there, please go to this page: <a href="http://users.smartgb.com/g/g.php?a=s&i=g19-01726-0d" target="_blank">guestbook!</a>.</p>
        </div>
        <div class="theme-selector">
            <label for="theme-color">Select theme color:</label>
            <input type="color" id="theme-color" onchange="changeThemeColor()">
        </div>
        <div class="new-post">
            <input type="text" id="blog-author" placeholder="Name">
            <textarea id="new-post-text" placeholder="What's on your mind?"></textarea>
            <input type="file" id="new-post-image" accept="image/*">
            <button onclick="addNewPost()">Post</button>
        </div>
        <div class="posts-container"></div>
    </div>
</body>
</html>