<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="blog.css" />
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Apply saved theme color from localStorage
            const savedTheme = localStorage.getItem('themeColor');
            if (savedTheme) {
                document.body.style.backgroundColor = savedTheme;
            }
            loadPosts();
            deployProject();
        });

        function changeThemeColor() {
            const themeColor = document.getElementById('theme-color').value;
            document.body.style.backgroundColor = themeColor;
            localStorage.setItem('themeColor', themeColor);
        }

        function addNewPost() {
            const newPostText = document.getElementById('new-post-text').value;
            const blogAuthor = document.getElementById('blog-author').value.trim() || 'anonymous';
            const newPostImage = document.getElementById('new-post-image').files[0];

            if (newPostText.trim() === '' && !newPostImage) return;

            let imageUrl = '';
            if (newPostImage) {
                // Read image file and convert to URL
                const reader = new FileReader();
                reader.onload = function (e) {
                    imageUrl = e.target.result;
                    const post = {
                        author: blogAuthor,
                        content: newPostText,
                        date: new Date().toISOString(),
                        imageUrl: imageUrl,
                        replies: []
                    };
                    savePost(post);
                    renderPost(post);
                };
                reader.readAsDataURL(newPostImage);
            } else {
                const post = {
                    author: blogAuthor,
                    content: newPostText,
                    date: new Date().toISOString(),
                    imageUrl: imageUrl,
                    replies: []
                };
                savePost(post);
                renderPost(post);
            }

            document.getElementById('new-post-text').value = '';
            document.getElementById('blog-author').value = '';
            document.getElementById('new-post-image').value = '';
        }

        function savePost(post) {
            const posts = JSON.parse(localStorage.getItem('posts')) || [];
            posts.push(post);
            localStorage.setItem('posts', JSON.stringify(posts));
        }

        function loadPosts() {
            const posts = JSON.parse(localStorage.getItem('posts')) || [];
            posts.forEach(post => renderPost(post));
        }

        function renderPost(post) {
            const postElement = document.createElement('div');
            postElement.className = 'post';

            const postHeader = document.createElement('div');
            postHeader.className = 'post-header';
            postHeader.textContent = `${post.author} - ${new Date(post.date).toLocaleString('en-US', { timeZone: 'America/New_York' })}`;

            const postContent = document.createElement('div');
            postContent.className = 'post-content';
            postContent.textContent = post.content;

            postElement.appendChild(postHeader);
            postElement.appendChild(postContent);

            if (post.imageUrl) {
                const postImage = document.createElement('img');
                postImage.className = 'post-image';
                postImage.src = post.imageUrl;
                postElement.appendChild(postImage);
            }

            const postControls = document.createElement('div');
            postControls.className = 'post-controls';

            const replyButton = document.createElement('button');
            replyButton.textContent = 'Reply';
            replyButton.onclick = () => toggleReplyForm(postElement);

            postControls.appendChild(replyButton);

            postElement.appendChild(postControls);

            const repliesContainer = document.createElement('div');
            repliesContainer.className = 'replies-container';
            post.replies.forEach(reply => {
                const replyElement = document.createElement('div');
                replyElement.className = 'reply';
                replyElement.innerHTML = `<strong>${reply.author}:</strong> ${reply.content}`;
                repliesContainer.appendChild(replyElement);
            });
            postElement.appendChild(repliesContainer);

            document.querySelector('.posts-container').prepend(postElement);
        }

        function toggleReplyForm(postElement) {
            let replyForm = postElement.querySelector('.reply-form');
            if (replyForm) {
                replyForm.remove();
            } else {
                replyForm = document.createElement('div');
                replyForm.className = 'reply-form';
                replyForm.innerHTML = `
                    <input type="text" class="reply-author" placeholder="Your name">
                    <textarea class="reply-text" placeholder="Write your reply..."></textarea>
                    <button onclick="addReply(this)">Reply</button>
                `;
                postElement.appendChild(replyForm);
            }
        }

        function addReply(button) {
            const replyForm = button.parentElement;
            const postElement = replyForm.closest('.post');
            const postDate = postElement.querySelector('.post-header').textContent.split(' - ')[1];
            const replyAuthor = replyForm.querySelector('.reply-author').value.trim() || 'anonymous';
            const replyText = replyForm.querySelector('.reply-text').value.trim();

            if (replyText === '') return;

            const posts = JSON.parse(localStorage.getItem('posts')) || [];
            const post = posts.find(p => new Date(p.date).toLocaleString('en-US', { timeZone: 'America/New_York' }) === postDate);
            const reply = {
                author: replyAuthor,
                content: replyText
            };

            if (post) {
                post.replies.push(reply);
                localStorage.setItem('posts', JSON.stringify(posts));
            }

            const replyElement = document.createElement('div');
            replyElement.className = 'reply';
            replyElement.innerHTML = `<strong>${reply.author}:</strong> ${reply.content}`;
            postElement.querySelector('.replies-container').appendChild(replyElement);

            replyForm.querySelector('.reply-author').value = '';
            replyForm.querySelector('.reply-text').value = '';
        }

        document.addEventListener('DOMContentLoaded', () => {
        // Apply saved theme color from localStorage
        const savedTheme = localStorage.getItem('themeColor');
        if (savedTheme) {
            document.body.style.backgroundColor = savedTheme;
        }
        loadPosts();
        deployProject(); // Fetch Cloudflare deployment information
    });

    function deployProject() {
    fetch('http://localhost:3000/api/deployments', {
        method: 'GET'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        console.log('Deployment status:', data);
    })
    .catch(error => {
        console.error('Error fetching deployment status:', error);
    });
}


    </script>
</head>

<body>
    <div class="navbar">
        <a href="mainpage.html" class="brand" style="text-decoration: none;">:D</a>
        <ul>
            <li><a href="clock.html">Clock</a></li>
            <li><a href="calendar.html">Calendar</a></li>
            <li><a href="upload.html">Image desktop</a></li>
            <li><a href="blog.html">Blogs</a></li>
            <li><a href="gallery.html">Gallery</a></li>
            <li><a href="settings.html">Settings</a></li>
        </ul>
    </div>
    <div class="main-container">
        <div class="theme-selector">
            <label for="theme-color">Select theme color:</label>
            <input type="color" id="theme-color" onchange="changeThemeColor()">
        </div>
        <div class="new-post">
            <input type="text" id="blog-author" placeholder="Name">
            <textarea id="new-post-text" placeholder="What's on your mind?"></textarea>
            <input type="file" id="new-post-image" accept="image/*">
            <button onclick="addNewPost()">Post</button>
        </div>
        <div class="posts-container"></div>
    </div>
</body>

</html>